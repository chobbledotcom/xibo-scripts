#!/usr/bin/env nix-shell
#! nix-shell -i bash -p buildah podman coreutils curl openssl
# shellcheck shell=bash
set -euo pipefail

# Docker Image Test Script
# Tests the xibo-web Docker image build and basic functionality

# Configuration
IMAGE_NAME="localhost/xibo-web-test"
CONTAINER_NAME="xibo-web-test-container"
TEST_PORT="3001"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
  echo -e "${GREEN}[INFO]${NC} $*"
}

log_warn() {
  echo -e "${YELLOW}[WARN]${NC} $*"
}

log_error() {
  echo -e "${RED}[ERROR]${NC} $*"
}

log_step() {
  echo ""
  echo -e "${GREEN}===${NC} $* ${GREEN}===${NC}"
}

cleanup() {
  log_step "Cleaning up test resources"
  
  # Stop and remove container if running
  if podman ps -a --format "{{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
    log_info "Stopping container: ${CONTAINER_NAME}"
    podman stop "${CONTAINER_NAME}" 2>/dev/null || true
    log_info "Removing container: ${CONTAINER_NAME}"
    podman rm "${CONTAINER_NAME}" 2>/dev/null || true
  fi
  
  # Remove test image (check with and without localhost prefix)
  if podman images --format "{{.Repository}}" | grep -q "xibo-web-test"; then
    log_info "Removing test image: ${IMAGE_NAME}"
    podman rmi "${IMAGE_NAME}:latest" 2>/dev/null || true
  fi
  
  log_info "Cleanup complete"
}

# Trap to ensure cleanup on exit
trap cleanup EXIT

# Check if required env vars are set
check_env_vars() {
  log_step "Checking environment variables"
  
  local missing_vars=()
  
  # SECRET_KEY_BASE is always auto-generated by docker-entrypoint
  log_info "Container will generate a fresh SECRET_KEY_BASE on startup"
  
  # Set dummy Xibo credentials for testing if not provided
  export XIBO_API_URL="${XIBO_API_URL:-https://example.com}"
  export XIBO_CLIENT_ID="${XIBO_CLIENT_ID:-test_client_id}"
  export XIBO_CLIENT_SECRET="${XIBO_CLIENT_SECRET:-test_client_secret}"
  
  log_info "XIBO_API_URL: ${XIBO_API_URL}"
  log_info "XIBO_CLIENT_ID: ${XIBO_CLIENT_ID}"
  log_info "Environment variables configured"
}

# Build the Docker image
build_image() {
  log_step "Building Docker image with buildah"
  
  log_info "Building ${IMAGE_NAME}..."
  buildah bud \
    --tag "${IMAGE_NAME}:latest" \
    --format docker \
    --file Dockerfile \
    .
  
  log_info "✓ Build complete"
}

# Verify image was created
verify_image() {
  log_step "Verifying image"
  
  # Check if image exists (podman adds localhost/ prefix automatically)
  if ! podman images "${IMAGE_NAME}" --format "{{.Repository}}:{{.Tag}}" | grep -q ":latest$"; then
    log_error "Image ${IMAGE_NAME}:latest not found"
    log_info "Available images:"
    podman images
    exit 1
  fi
  
  log_info "✓ Image ${IMAGE_NAME}:latest exists"
  
  # Show image details
  log_info "Image details:"
  podman images "${IMAGE_NAME}:latest" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"
}

# Test running the container
test_container() {
  log_step "Testing container startup"
  
  log_info "Starting container on port ${TEST_PORT}..."
  
  podman run -d \
    --name "${CONTAINER_NAME}" \
    -p "${TEST_PORT}:3000" \
    -e "XIBO_API_URL=${XIBO_API_URL}" \
    -e "XIBO_CLIENT_ID=${XIBO_CLIENT_ID}" \
    -e "XIBO_CLIENT_SECRET=${XIBO_CLIENT_SECRET}" \
    "${IMAGE_NAME}:latest"
  
  log_info "Container started, waiting for Rails to boot..."
  
  # Wait for container to be healthy (max 30 seconds)
  local max_wait=30
  local waited=0
  local healthy=false
  
  while [ $waited -lt $max_wait ]; do
    if podman ps --format "{{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
      # Check if Rails is responding
      if curl -f -s -o /dev/null "http://localhost:${TEST_PORT}" 2>/dev/null; then
        healthy=true
        break
      fi
    else
      log_error "Container stopped unexpectedly"
      podman logs "${CONTAINER_NAME}"
      exit 1
    fi
    
    sleep 1
    waited=$((waited + 1))
    echo -n "."
  done
  echo ""
  
  if [ "$healthy" = true ]; then
    log_info "✓ Container is running and responding"
  else
    log_warn "Container is running but not responding on port ${TEST_PORT} yet"
    log_info "This may be normal if Rails takes longer to boot"
  fi
  
  # Show container logs
  log_info "Container logs (last 20 lines):"
  podman logs --tail 20 "${CONTAINER_NAME}"
}

# Inspect container
inspect_container() {
  log_step "Inspecting container"
  
  log_info "Container status:"
  podman ps -a --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
  
  log_info "Container processes:"
  podman top "${CONTAINER_NAME}" || log_warn "Could not get process list"
}

# Run all tests
run_tests() {
  log_step "Starting Docker Image Tests"
  log_info "Image: ${IMAGE_NAME}"
  log_info "Test port: ${TEST_PORT}"
  echo ""
  
  check_env_vars
  build_image
  verify_image
  test_container
  inspect_container
  
  log_step "Tests Complete"
  log_info "✓ Docker image builds successfully"
  log_info "✓ Container starts without errors"
  log_info "Container will be cleaned up on exit"
  echo ""
  log_info "To manually inspect the running container, press Ctrl+C to skip cleanup"
  log_info "Otherwise, container will stop in 10 seconds..."
  
  sleep 10
}

# Main execution
main() {
  # Change to project root
  cd "$(dirname "$0")/.."
  
  # Check if Dockerfile exists
  if [ ! -f "Dockerfile" ]; then
    log_error "Dockerfile not found in $(pwd)"
    exit 1
  fi
  
  run_tests
}

main "$@"
