#!/usr/bin/env bash
set -euo pipefail

# Push to Docker Hub
# 
# Make sure you're logged in: podman login docker.io

# Configuration
IMAGE_NAME="xibo-web"
DOCKERHUB_REPO="dockerstefn/xibo"
VERSION_FILE=".docker-version"

# Read current version or initialize
if [ -f "$VERSION_FILE" ]; then
    CURRENT_VERSION=$(cat "$VERSION_FILE")
else
    CURRENT_VERSION="0"
fi

# Bump version
NEW_VERSION=$((CURRENT_VERSION + 1))

echo "=== Xibo Docker Hub Push ==="
echo "Image: ${IMAGE_NAME}"
echo "Repository: ${DOCKERHUB_REPO}"
echo "Version: v${NEW_VERSION} (previous: v${CURRENT_VERSION})"
echo ""

# Build the image using buildah (no daemon required)
echo "Building image with buildah..."
buildah bud \
  -t "${IMAGE_NAME}:latest" \
  -t "${DOCKERHUB_REPO}:v${NEW_VERSION}" \
  -t "${DOCKERHUB_REPO}:latest" \
  .

echo ""
echo "✅ Build complete!"

# Push to Docker Hub using podman
echo ""
echo "Pushing to Docker Hub..."
echo "Note: Make sure you're logged in with: podman login docker.io"
podman push "${DOCKERHUB_REPO}:v${NEW_VERSION}"
podman push "${DOCKERHUB_REPO}:latest"

# Save new version
echo "$NEW_VERSION" > "$VERSION_FILE"

echo ""
echo "✅ Push complete! Version v${NEW_VERSION} is now live."
echo ""
echo "Pull with:"
echo "  docker pull ${DOCKERHUB_REPO}:latest"
echo "  docker pull ${DOCKERHUB_REPO}:v${NEW_VERSION}"
echo ""
echo "Or with podman:"
echo "  podman pull ${DOCKERHUB_REPO}:latest"
