#!/usr/bin/env bash
set -euo pipefail

# Push to GitHub Container Registry
# 
# Uses 'gh' CLI for authentication (must be logged in with 'gh auth login')

# Configuration
IMAGE_NAME="xibo-web"
GHCR_REPO="ghcr.io/chobbledotcom/xibo-scripts"
VERSION_FILE=".docker-version"

# Read current version or initialize
if [ -f "$VERSION_FILE" ]; then
    CURRENT_VERSION=$(cat "$VERSION_FILE")
else
    CURRENT_VERSION="0"
fi

# Bump version
NEW_VERSION=$((CURRENT_VERSION + 1))

echo "=== Xibo GitHub Container Registry Push ==="
echo "Image: ${IMAGE_NAME}"
echo "Repository: ${GHCR_REPO}"
echo "Version: v${NEW_VERSION} (previous: v${CURRENT_VERSION})"
echo ""

# Authenticate with GitHub Container Registry using gh CLI
echo "Authenticating with GitHub Container Registry..."

# Check if gh token has required scopes
if ! gh auth status 2>&1 | grep -q "write:packages"; then
    echo "⚠️  Your gh token needs 'write:packages' scope for pushing images."
    echo ""
    echo "Please refresh your authentication with the required scopes:"
    echo "  gh auth refresh -h github.com -s write:packages"
    echo ""
    exit 1
fi

gh auth token | podman login ghcr.io -u "$(gh api user --jq .login)" --password-stdin
echo "✅ Authenticated"
echo ""

# Build the image using buildah (no daemon required)
echo "Building image with buildah..."
buildah bud \
  -t "${IMAGE_NAME}:latest" \
  -t "${GHCR_REPO}:v${NEW_VERSION}" \
  -t "${GHCR_REPO}:latest" \
  .

echo ""
echo "✅ Build complete!"

# Push to GitHub Container Registry using podman
echo ""
echo "Pushing to GitHub Container Registry..."
podman push "${GHCR_REPO}:v${NEW_VERSION}"
podman push "${GHCR_REPO}:latest"

# Save new version
echo "$NEW_VERSION" > "$VERSION_FILE"

echo ""
echo "✅ Push complete! Version v${NEW_VERSION} is now live."
echo ""
echo "Pull with:"
echo "  docker pull ${GHCR_REPO}:latest"
echo "  docker pull ${GHCR_REPO}:v${NEW_VERSION}"
echo ""
echo "Or with podman:"
echo "  podman pull ${GHCR_REPO}:latest"
